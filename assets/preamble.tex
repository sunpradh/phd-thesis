%======================================================================
% PREAMBLE
%======================================================================

%----------------------------------------
% DOCUMENT APPEARANCE
%----------------------------------------

% Fonts
%----------------------------------------
\usepackage{fontspec}
\usepackage{mlmodern}
\usepackage[T1]{fontenc}
\setsansfont{IBM Plex Sans}
\newfontfamily{\PlexMedium}{IBM Plex Sans Medm}


% Custom chapter heading style
%----------------------------------------
\makechapterstyle{mychapter}{
    \chapterstyle{companion}
    \setlength{\beforechapskip}{0cm}
    \setlength{\afterchapskip}{2.5cm}
    \setlength{\topskip}{0cm}
    \setlength{\midchapskip}{5pt}
    \setlength{\chapindent}{0.75\marginparsep}
    \addtolength{\chapindent}{0.75\marginparwidth}
    \renewcommand*{\chapnamefont}{}
    \renewcommand*{\printchaptername}{}
    \renewcommand*{\chapnumfont}{\sffamily\LARGE\bfseries}
    \renewcommand*{\printchapternum}{%
        \raggedleft\chapnumfont %
        \ifanappendix appendix~ \thechapter %
        \else chapter~ \numtoname{\thechapter}\fi%
    }
    \renewcommand*{\chaptitlefont}{\normalfont\sffamily\HUGE}
    \renewcommand{\printchaptertitle}[1]{%
        \begin{adjustwidth}{\chapindent}{-\chapindent}
            \raggedleft \chaptitlefont ##1\par\nobreak
        \end{adjustwidth}
    }
}


% Custom section style
%----------------------------------------
\setsecnumdepth{subsection}
\settocdepth{subsection}
\hangsecnum
\makeheadstyles{myheadings}{
    \renewcommand*{\secheadstyle}{\sffamily\Large\PlexMedium}
    \renewcommand*{\subsecheadstyle}{\sffamily\large\PlexMedium}
    \renewcommand*{\subsubsecheadstyle}{\sffamily\normalsize\PlexMedium}
}


% Custom page style
%----------------------------------------
\setlength{\headwidth}{\textwidth}
\addtolength{\headwidth}{0.75\marginparsep}
\addtolength{\headwidth}{0.75\marginparwidth}
\makepagestyle{mypagestyle}
\makerunningheadwidth{mypagestyle}{\headwidth}
\makeheadrule{mypagestyle}{\headwidth}{\normalrulethickness}
\makeheadposition{mypagestyle}{flushright}{flushleft}{}{}
\makepsmarks{mypagestyle}{%
    \nouppercaseheads
    \createmark{chapter}{both}{nonumber}{}{}
    \createmark{section}{right}{nonumber}{}{}
    \createplainmark{toc}{both}{\contentsname}
    \createplainmark{lof}{both}{\listfigurename}
    \createplainmark{lot}{both}{\listtablename}
    \createplainmark{bib}{both}{\bibname}
    \createplainmark{index}{both}{\indexname}
    \createplainmark{glossary}{both}{\glossaryname}
}

% Headers
\makeevenhead{mypagestyle}{\normalfont\sffamily\PlexMedium\rightmark}{}{}
\makeoddhead{mypagestyle}{}{}{\normalfont\PlexMedium\leftmark}

% Footers
\makeevenfoot{mypagestyle}{}{\normalfont\PlexMedium\thepage}{}
\makeoddfoot{mypagestyle}{}{\normalfont\PlexMedium\thepage}{}
\addtolength{\footskip}{20pt}

% Fix chapter page style
\copypagestyle{chapter}{plain}
\makeevenfoot{chapter}{}{\normalfont\PlexMedium\thepage}{}
\makeoddfoot{chapter}{}{\normalfont\PlexMedium\thepage}{}


% Set all the custom styles
\headstyles{myheadings}
\chapterstyle{mychapter}
\pagestyle{mypagestyle}

% Custom caption style
%----------------------------------------
\captiondelim{.\hspace{1em}}
\captionnamefont{\footnotesize\PlexMedium}
\captiontitlefont{\footnotesize\sffamily}
\captionstyle{\linespread{1.1}}

% Macro for figure with caption on the side
\usepackage{xifthen}

\newcommand{\FigureSideCaption}[3][]{
    \begin{minipage}[t]{0.5\textwidth}
        \centering
        #2
    \end{minipage}\hfill
    \begin{minipage}[b]{0.45\textwidth}
        \caption{#3}%
        \ifthenelse{\isempty{#1}}{}{\label{#1}}%
    \end{minipage}%
}

% Line spacing
\linespread{1.1}

%----------------------------------------
% MATH
%----------------------------------------
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{physics}
\usepackage{bm}
\usepackage{bbm}
\usepackage{slashed}

% Show equation labels
\usepackage[]{showlabels}
\renewcommand{\showlabelfont}{\scriptsize\sffamily\color{gray}}

% Math macros

\newcommand{\R}{\mathbb{R}} % Real field
\newcommand{\Z}{\mathbb{Z}} % integers
\newcommand{\C}{\mathbb{C}} % Complex field
\newcommand{\onehalf}{$\frac{1}{2}$} % 1/2
\newcommand{\identity}{\mathbbm{1}} % identity operator
% labels for symbols
\newcommand{\phys}{\text{phys}} % 'physical' label
\newcommand{\gi}{\text{gi}} % gauge-invariant label
\newcommand{\ising}{\text{Ising}}
%
\newcommand{\hc}{\text{h.c.}} % hermitian conjugate text
\newcommand{\W}{W_{\square}} % single plaquette Wilson loop
\newcommand{\action}{\mathcal{S}} % action
\newcommand{\HilbertSpace}{\mathcal{H}} % Hilbert space
\newcommand{\Hphys}{\HilbertSpace_{\phys}} % physical Hilbert space
% Groups and algebra
\newcommand{\U}{\mathrm{U}} % unitary group
\newcommand{\SU}{\text{SU}} % special unitary group
\newcommand{\su}{\mathfrak{su}} % special unitary algebra
\newcommand{\g}{\mathfrak{g}} % Lie algebra
\newcommand{\algebra}{\mathcal{A}} % operator algebra
\newcommand{\generator}{\hat{\ell}}
\newcommand{\transport}{\hat{u}}
% Hamiltonians
\newcommand{\HamilKS}{H_{\text{KS}}} % Kogut-Susskind Hamiltonian
\newcommand{\HIsing}{H^{\ising}} % Ising Hamiltonian
\newcommand{\Hclock}{H^{\text{clock}}} % Clock Hamiltonian
\newcommand{\Hladder}{H^{\text{lad}}} % Clock Hamiltonian
% shorthand for the lattice and its objects
\newcommand{\lattice}{\mathbb{L}} % lattice
\newcommand{\duallattice}{\mathbb{L}^{\ast}} % lattice
\newcommand{\link}{\ell} % link
\newcommand{\plaquette}{\square}
% Some operators on the lattice
\newcommand{\PlaqOp}{U_{\plaquette}}
\newcommand{\Wilson}{\overline{W}}
\newcommand{\tHooft}{\overline{S}}
% Ladder links
\newcommand{\toplink}{\link^\uparrow}
\newcommand{\botlink}{\link^\downarrow}
\newcommand{\runglink}{\link^0}
% Operators on the ladder
\newcommand{\Uup}{U^{\uparrow}}
\newcommand{\Udown}{U^{\downarrow}}
\newcommand{\Urung}{U^0}
\newcommand{\Vup}{V^{\uparrow}}
\newcommand{\Vdown}{V^{\downarrow}}
\newcommand{\Vrung}{V^0}
% Gauss operators
\newcommand{\GaussUp}{G^{\uparrow}}
\newcommand{\GaussDown}{G^{\downarrow}}
% shorthand for the coefficients of the ladder duality map
\newcommand{\coeffup}{c^{\uparrow}}
\newcommand{\coeffdown}{c^{\downarrow}}

\newcommand{\Or}{\mathrm{O}}

% redefine some math macro
% for consistency with the mlmodern font
\renewcommand{\dd}{\text{d}}
\renewcommand{\tr}{\text{tr}}
\renewcommand{\exp}{\text{exp}}
\renewcommand{\laplacian}{\Delta}


%----------------------------------------
% GRAPHICS
%----------------------------------------
\usepackage{xcolor}
\usepackage{graphicx}

% TikZ
\usepackage{tikz}
\usetikzlibrary{arrows.meta, decorations.markings, patterns, fit, positioning}
\tikzset{
    font=\footnotesize,
    >={stealth},
    ->-/.style={
        decoration={markings, mark=at position #1 with {\arrow{stealth}}},
        postaction={decorate}
    },
    -<-/.style={
        decoration={markings, mark=at position #1 with {\arrow{stealth}}},
        postaction={decorate}
    },
    site/.style={circle, inner sep=0pt, minimum size=4pt, draw=Grey60, fill=white},
    ladder/.style={Grey40, step=1, thin},
    lattice/.style={Grey40, step=2, thin},
    freccia/.style={-stealth, very thick, shorten >=5pt, shorten <=5pt},
    plaq/.style={Blue80, very thick, ->-=0.6},
    elec/.style={Red, very thick, ->-=0.6},
    X/.style = {Blue80, ultra thick},
    Z/.style = {Red, ultra thick},
    U/.style = {Blue80, ultra thick, ->-=0.6},
    V/.style = {Red, ultra thick, ->-=0.6},
    up/.style = {Green, ultra thick},
    up spin/.style = {-stealth, ultra thick, Green},
    down spin/.style = {stealth-, ultra thick},
    flux/.style = {fill=Green, fill opacity=0.1},
    X site/.style = {circle, inner sep=0 pt, minimum size=5pt, draw=black, fill=Blue80},
    Z site/.style = {circle, inner sep=0 pt, minimum size=5pt, draw=black, fill=Red},
    box/.style={dotted, rounded corners, thick}
}

% Custom colors
% load IBM Carbon theme
\usepackage{xcolor}
\input{assets/theme.tex}
\colorlet{Blue}{Blue80}
\colorlet{Gray}{Grey70}

\newcommand{\UpArrow}[2]{\draw[up spin] (#1,#2) ++(0,-0.7) -- ++(0,1.4);}
\newcommand{\DownArrow}[2]{\draw[down spin] (#1,#2) ++(0,-0.7) -- ++(0,1.4);}
\newcommand{\Spin}[3]{%
    \ifthenelse{\equal{#1}{up}}{\UpArrow{#2}{#3}}{}%
    \ifthenelse{\equal{#1}{down}}{\DownArrow{#2}{#3}}{}
}
\newcommand{\DrawSites}[2]{
    \foreach \y in {#2} \foreach \x in {#1} \draw (\x,\y) node [site] {};
}

% TikZ caching
\usetikzlibrary{external}
\tikzset{external/system call={lualatex -shell-escape -halt-on-error -interaction=batchmode -enable-write18 -jobname "\image" "\texsource"}}
\tikzexternalize[prefix=assets/cache/] % folder for cache

% Plots
\usepackage{pgfplots}
\pgfplotsset{compat=1.16} % fixes some pgfplots cross-platform issue
\usepgfplotslibrary{groupplots}

\usepackage{wrapfig}


%----------------------------------------
% MISC
%----------------------------------------
\usepackage[colorlinks, linkcolor=blue, urlcolor=Blue]{hyperref}
\usepackage{bookmark}
\usepackage{dirtytalk}

\usepackage{xspace}
\newcommand{\dof}{d.o.f.\xspace}

% macro for TODO notes
\newcommand{\todo}[1]{\textcolor{red}{[ \textsf{#1} ]}}
% macro for missing citations
\newcommand{\citneeded}{\textcolor{red}{\textsf{\textsuperscript{[citation?]}}}}


%----------------------------------------
% Bibliography
%----------------------------------------
\usepackage[style=numeric-comp, sorting=none, bibstyle=nature]{biblatex}
\bibliography{assets/biblio.bib}

\ExecuteBibliographyOptions{doi=false}
\ExecuteBibliographyOptions{url=false}
\newbibmacro{string+doi}[1]{%
  \iffieldundef{doi}{#1}{\href{http://dx.doi.org/\thefield{doi}}{#1}}}
\DeclareFieldFormat{title}{\usebibmacro{string+doi}{\mkbibemph{#1}}}
\DeclareFieldFormat[article]{title}{\usebibmacro{string+doi}{\mkbibquote{#1}}}


%----------------------------------------
% Macros for front page
%----------------------------------------
% Variables
\newcommand{\thephdcoordinator}{}
\newcommand{\thesupervisor}{}
\newcommand{\thecosupervisor}{}
\newcommand{\ilsettoreconcorsuale}{}
\newcommand{\ilsettoredisciplinare}{}

\newcommand{\phdcoordinator}[1]{\renewcommand{\thephdcoordinator}{#1}}
\newcommand{\supervisor}[1]{\renewcommand{\thesupervisor}{#1}}
\newcommand{\cosupervisor}[1]{\renewcommand{\thecosupervisor}{#1}}
\newcommand{\settoreconcorsuale}[1]{\renewcommand{\ilsettoreconcorsuale}{#1}}
\newcommand{\settoredisciplinare}[1]{\renewcommand{\ilsettoredisciplinare}{#1}}
